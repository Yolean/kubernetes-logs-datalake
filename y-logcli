#!/usr/bin/env bash
set -euo pipefail

# y-logcli - Query Kubernetes container logs stored as Parquet in S3
# S3 path layout: /<namespace>/<pod>/<container>/YYYY/MM/DD/HH/MM/<uuid>.parquet

S3_ENDPOINT="localhost:30070"
S3_BUCKET="fluentbit-logs"
S3_ACCESS_KEY="demoaccess"
S3_SECRET_KEY="demosecret"

usage() {
  cat <<'EOF'
Usage:
  y-logcli --context=<name> query '{<selectors>}' [--since=<duration>]

Examples:
  y-logcli --context=default query '{pod="app-abc12345-abcdef"}'
  y-logcli --context=default query '{namespace="qa"}' --since=5m
  y-logcli --context=default query '{container="build"}' --since=1h
  y-logcli --context=default query '{namespace="default"}' -o raw

Selectors: namespace, pod, container (comma-separated inside braces)
Duration: s (seconds), m (minutes), h (hours)
Output:  -o table (default), -o raw (like kubectl logs), -o lines (key=value per field)
EOF
  exit 1
}

# Parse arguments
CONTEXT=""
QUERY=""
SINCE=""
OUTPUT="table"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --context=*)
      CONTEXT="${1#--context=}"
      shift
      ;;
    query)
      shift
      QUERY="${1:-}"
      shift || true
      ;;
    --since=*)
      SINCE="${1#--since=}"
      shift
      ;;
    -o)
      shift
      OUTPUT="${1:-table}"
      shift || true
      ;;
    *)
      echo "Unknown argument: $1" >&2
      usage
      ;;
  esac
done

if [[ -z "$CONTEXT" || -z "$QUERY" ]]; then
  usage
fi

# Parse label selectors in promql format such as '{key="value",key2="value2"}'
declare -a SELECTOR_KEYS=()
declare -a SELECTOR_VALUES=()

# Strip braces
INNER="${QUERY#\{}"
INNER="${INNER%\}}"

if [[ -n "$INNER" ]]; then
  IFS=',' read -ra PAIRS <<< "$INNER"
  for pair in "${PAIRS[@]}"; do
    pair="$(echo "$pair" | xargs)"  # trim whitespace
    key="${pair%%=*}"
    val="${pair#*=}"
    val="${val#\"}"
    val="${val%\"}"
    SELECTOR_KEYS+=("$key")
    SELECTOR_VALUES+=("$val")
  done
fi

# Build S3 glob path with partition pushdown
build_s3_path() {
  local ns="*" pod="*" container="*"
  for i in "${!SELECTOR_KEYS[@]}"; do
    case "${SELECTOR_KEYS[$i]}" in
      namespace)  ns="${SELECTOR_VALUES[$i]}" ;;
      pod)        pod="${SELECTOR_VALUES[$i]}" ;;
      container)  container="${SELECTOR_VALUES[$i]}" ;;
    esac
  done
  echo "s3://${S3_BUCKET}/${ns}/${pod}/${container}/**/*.parquet"
}

# Convert --since duration to SQL interval
since_to_interval() {
  local dur="$1"
  local num="${dur%[smh]}"
  local unit="${dur: -1}"
  case "$unit" in
    s) echo "${num} seconds" ;;
    m) echo "${num} minutes" ;;
    h) echo "${num} hours" ;;
    *) echo "Invalid duration unit: $unit" >&2; exit 1 ;;
  esac
}

S3_PATH="$(build_s3_path)"

# Build WHERE clause
WHERE_PARTS=()

if [[ -n "$SINCE" ]]; then
  INTERVAL="$(since_to_interval "$SINCE")"
  WHERE_PARTS+=("date::TIMESTAMPTZ >= now() - INTERVAL '${INTERVAL}'")
fi

WHERE_CLAUSE=""
if [[ ${#WHERE_PARTS[@]} -gt 0 ]]; then
  WHERE_CLAUSE="WHERE $(IFS=' AND '; echo "${WHERE_PARTS[*]}")"
fi

case "$OUTPUT" in
  raw)    SELECT_COLS="message" ; DUCKDB_MODE=(-cmd ".mode list" -cmd ".headers off") ;;
  lines)  SELECT_COLS="*"      ; DUCKDB_MODE=(-cmd ".mode line") ;;
  table)  SELECT_COLS="*"      ; DUCKDB_MODE=() ;;
  *)      echo "Unknown output mode: $OUTPUT (use table, raw, or lines)" >&2; exit 1 ;;
esac

SQL=$(cat <<EOF
INSTALL httpfs;
LOAD httpfs;
SET s3_region = 'us-east-1';
SET s3_endpoint = '${S3_ENDPOINT}';
SET s3_access_key_id = '${S3_ACCESS_KEY}';
SET s3_secret_access_key = '${S3_SECRET_KEY}';
SET s3_use_ssl = false;
SET s3_url_style = 'path';

SELECT ${SELECT_COLS}
FROM read_parquet('${S3_PATH}', hive_partitioning=false)
${WHERE_CLAUSE}
ORDER BY date;
EOF
)

duckdb ${DUCKDB_MODE[@]+"${DUCKDB_MODE[@]}"} -c "$SQL"

QUERY_SQL="SELECT ${SELECT_COLS}
FROM read_parquet('${S3_PATH}', hive_partitioning=false)
${WHERE_CLAUSE}
ORDER BY date;"

echo ""
echo "-- query executed:"
echo "$QUERY_SQL"
