[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

[INPUT]
    Name              tail
    DB                /var/lib/fluent-bit/tail-db
    DB.locking        true
    Path              /var/log/pods/*/*/*.log
    Parser            cri
    Tag               kube.<pod_id>.<namespace_name>.<pod_name>.<container_name>
    # k3d log paths match the production regex
    Tag_Regex         /var/log/pods/(?<namespace_name>[^_/]+)_(?<pod_name>[^_/]+)_(?<pod_id>[^_/]+)/(?<container_name>[^/]+)/.*
    # avoid potential infinite logging
    Exclude_Path      /var/log/pods/*/fluent-bit/*.log
    Read_from_Head    On
    Skip_Long_Lines   On
    Refresh_Interval  5

# The CRI parser has Time_Keep On, producing a 'time' record field (nanosecond string).
# We drop it here because the OUTPUT section writes the internal timestamp as 'time'
# (json_date_key=time, json_date_format=epoch_ms) â€” a compact BIGINT in parquet.
# Removing the CRI 'time' avoids a conflict with the output's 'time' key.
[FILTER]
    Name     modify
    Match    kube.*
    Remove   time
    Add      cluster ${CLUSTER_NAME}

[OUTPUT]
    Name                         s3
    Match                        kube.*
    bucket                       fluentbit-logs
    endpoint                     http://versitygw:7070
    tls                          Off
    use_put_object               On
    compression                  parquet
    json_date_key                time
    json_date_format             epoch_ms
    total_file_size              1M
    upload_timeout               15s
    s3_key_format_tag_delimiters .
    # Ideally s3_key_format would use hive-style paths (/namespace=$TAG[2]/pod=$TAG[3]/...)
    # but Fluent Bit's uri_encode() in src/flb_signv4.c excludes '=' from percent-encoding,
    # while the SigV4 spec requires it (%3D). versitygw (fixed in #807) encodes correctly,
    # causing SignatureDoesNotMatch. Using positional dirs as a workaround;
    # Consumers must reconstruct namespace/pod/container columns from the file path at query time.
    s3_key_format                /${CLUSTER_NAME}/$TAG[2]/$TAG[3]/$TAG[4]/%Y/%m/%d/%H/%M/$UUID.parquet
