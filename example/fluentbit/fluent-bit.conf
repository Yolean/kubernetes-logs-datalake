[SERVICE]
    Flush        1
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf

[INPUT]
    Name              tail
    DB                /tmp/fluent-bit/tail-db
    DB.locking        true
    Path              /var/log/pods/*/*/*.log
    Parser            cri
    Tag               kube.<pod_id>.<namespace_name>.<pod_name>.<container_name>
    # k3d log paths match the production regex
    Tag_Regex         /var/log/pods/(?<namespace_name>[^_/]+)_(?<pod_name>[^_/]+)_(?<pod_id>[^_/]+)/(?<container_name>[^/]+)/.*
    # avoid potential infinite logging
    Exclude_Path      /var/log/pods/*/fluent-bit/*.log
    Read_from_Head    On
    Skip_Long_Lines   On
    Refresh_Interval  5

# The built-in CRI parser has Time_Keep On, so both 'date' (internal timestamp,
# microseconds) and 'time' (record field, nanoseconds) end up in parquet.
# 'date' is the internal timestamp and can't be removed via filters.
# Drop 'time' to avoid storing both â€” 'date' is sufficient for queries.
[FILTER]
    Name     modify
    Match    kube.*
    Remove   time

# NOTE: hive-style s3_key_format (namespace=$TAG[2]/...) causes SignatureDoesNotMatch
# with versitygw due to '=' in path. Using positional dirs instead: /namespace/pod/container/...
[OUTPUT]
    Name                         s3
    Match                        kube.*
    bucket                       fluentbit-logs
    endpoint                     http://versitygw:7070
    tls                          Off
    use_put_object               On
    compression                  parquet
    total_file_size              1M
    upload_timeout               15s
    s3_key_format                /$TAG[2]/$TAG[3]/$TAG[4]/%Y/%m/%d/%H/%M/$UUID.parquet
    s3_key_format_tag_delimiters .
